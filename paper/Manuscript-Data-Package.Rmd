---
title: "ActiveCA: Time Use Data from the General Social Survey of Canada to Study Active Travel"
author:
  - name: "Anon1"
    email: "Anon1@anon.org"
    affiliation: CODE
    footnote: 1
  - name: "Anon2"
    email: "Anon2@anon.org"
    affiliation: CODE
  - name: "Anon3"
    email: "Anon3@anon.org"
    affiliation: CODE
address:
  - code: CODE
    address: "Some school"
footnote:
  - code: 1
    text: "Corresponding Author"
abstract: 
  "This paper describes {ActiveCA}, and open data product with Canadian time use 
data. {ActiveCA} is an `R` data package that contains analysis-ready data related 
to active travel spanning almost 40 years, extracted from cycles 2 (1986), 7 (1992),
12 (1998), 19 (2005), 24 (2010), and 29 (2015) of Canada's General Social Survey.
Active travel is characterized by mode, with walking being part of every cycle 
and bicycling starting in 1992. The attributes of active trips are the types of 
locations of origins and destinations, the duration of trips, and episode weights
for expanding the trips to population-wide estimates. Based on the year of the 
survey, a variety of locations are coded. In earlier cycles, these include home,
work or school, and other's home, whereas in later cycles these are augmented with
locations such as grocery stores, restaurants, outdoor destinations, and others.
The geographical resolution includes the province and whether the episode was in
an urban or rural setting." 
    
keywords: Active; mobility; walking; cycling; travel time; time-use; General Social Survey 
classoption:
  - Royal
  - times
bibliography: bibfile.bib
bibliographystyle: sageh
output:
  rticles::sage_article:
    keep_tex: yes
editor_options: 
  markdown: 
    wrap: 72
---

<!-- 
FROM THE ABSTRACT:

The package also details the respondent's region characteristics, specifying wheter they live in a metropolitan area and their province of residency. {ActiveCA} also provides pre-estimated impedance functions for active travel for Canadian Metropolitan Area and Census Agglomerations, which can be used in accessibility analysis to calculate the cost of travel between different locations. The package will continue to expand with contributions from the authors and the broader community through requests in the future. {ActiveCA} is freely accessible for exploration and download from the associated Github repository, where the documentation and code involved in creating and manipulating data are detailed.
-->

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  comment = '', 
  out.width = "1\\linewidth")

knitr::knit_hooks$set(inline = function(x) {
  if (is.numeric(x)) {
    format(x, big.mark = ",", scientific = FALSE)
  } else {
    x
  }
})

opts <- options(knitr.kable.NA = "")
```

```{r install-data-package, include=FALSE}
if (!require("ActiveCA", character.only = TRUE)) {
      remotes::install_github("dias-bruno/ActiveCA",
                        build_vignettes = TRUE)
}

rm(list=ls())
```

```{r load-packages, include=FALSE, cache=FALSE}
# Load packages
library(ActiveCA)
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(reshape2)
library(rlang)
library(scales)
library(gridExtra)
library(ggpubr)
library(grid)
library(stats)
library(Hmisc)
```

```{r load-data, include = FALSE}
# Load data
data("gss_episodes")
data("gss_impedances")
data("gss_main_2015")


# Original main and episode files from 2015 to display table examples

gss_m_2015 <- read.csv(paste0(here(), "/data-raw/source-files/Time-use-2015/gss-m.csv"))
gss_e_2015 <- read.csv(paste0(here(), "/data-raw/source-files/Time-use-2015/gss-e.csv"))

# Processed main files
data("gss_main_2015")
data("gss_main_2010")
data("gss_main_2005")
data("gss_main_1998")
data("gss_main_1992")
data("gss_main_1986")
```


```{r rename-labels, include = FALSE}
# Renaming 'dest_label' and 'orig_label' values to reduce table space
gss_episodes_renamed <- gss_episodes %>%
  mutate(dest_label = case_when(
    dest_label == "Grocery store, other stores or mall" ~ "Grocery store",
    dest_label == "Restaurant, bar or club" ~ "Restaurant",
    dest_label == "Sports centre, field or arena" ~ "Sport area",
    dest_label == "Medical, dental or other health clinic" ~ "Health clinic",
    dest_label == "In the neighbourhood" ~ "Neighbourhood",
    dest_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ dest_label  # Keep all other values as they are
  ), 
  orig_label = case_when(
    orig_label == "Grocery store, other stores or mall" ~ "Grocery store",
    orig_label == "Restaurant, bar or club" ~ "Restaurant",
    orig_label == "Sports centre, field or arena" ~ "Sport area",
    orig_label == "Medical, dental or other health clinic" ~ "Health clinic",
    orig_label == "In the neighbourhood" ~ "Neighbourhood",
    orig_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ orig_label))

gss_impedances_renamed <- gss_impedances %>%
  mutate(dest_label = case_when(
    dest_label == "Grocery store, other stores or mall" ~ "Grocery store",
    dest_label == "Restaurant, bar or club" ~ "Restaurant",
    dest_label == "Sports centre, field or arena" ~ "Sport area",
    dest_label == "Medical, dental or other health clinic" ~ "Health clinic",
    dest_label == "In the neighbourhood" ~ "Neighbourhood",
    dest_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ dest_label  # Keep all other values as they are
  ), 
  orig_label = case_when(
    orig_label == "Grocery store, other stores or mall" ~ "Grocery store",
    orig_label == "Restaurant, bar or club" ~ "Restaurant",
    orig_label == "Sports centre, field or arena" ~ "Sport area",
    orig_label == "Medical, dental or other health clinic" ~ "Health clinic",
    orig_label == "In the neighbourhood" ~ "Neighbourhood",
    orig_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ orig_label))
```

# Introduction

The objective of this paper is to introduce {ActiveCA}, an open data product with
time use data from Canada's General Social Surveys. Open data products
(ODPs) are the outcome of a process that transforms raw data (open or not) into 
analysis-ready data, following a transparent process in which all stages of
development follow open principles [@arribas-bel2021]. ODPs, while still open, 
differ from general open data in their degree of ease of access, their heightened 
usability, and potentially the value they add to the raw data. 

{ActiveCA} provides analysis-ready data concerning active travel in Canada spanning
a period of almost 40 years. The source of these data is Canada's program of 
General Social Surveys (GSSs). This program is designed to provide cross-sectional
data on topics of interest to improve the well-being of Canadians. As part of this
program, every five to seven years the survey is done on the topic of time use. 
Concretely, {ActiveCA} covers Cycles 2 (1986), 7 (1992), 12 (1998), 19 (2005),
24 (2010), and 29 (2015) of the GSS. Time use data in these surveys is coded using
a very fine grain, from time spent in chores, leisure, and sleeping, to time spent
working or at school. These surveys have proved valuable in investigations of 
mobility and quality of life [@spinneyTransport2009], the relationship between
active travel and transit use [@lachapelleLonger2016], and travel behavior and time
poverty [@kimFacing2024], to name but a few examples.

For {ActiveCA} and using GSS Public Use Microdata Files (PUMFs), we extracted all data needed to characterize active travel 
in Canada, namely, episodes where the activity was identified as moving between 
an origin and a destination, either by walking or cycling. Although Statistics 
Canada offers Public Use Microdata Files and documentation for the GSS program 
[see @statisticscanada2024], accessing these files, and preparing  them for analysis
is not a straightforward matter, given their size and complexity.  The  process 
of extracting information of interest from the source files is  time-consuming, 
tedious, and challenging and/or prone to error due to the expertise required to 
work with these files. To create {ActiveCA} we collected, cleaned, and processed
the cycles of the GSS  surveys concerning time use to make them ready for analysis.

{ActiveCA} is distributed as an `R` package with a number of data 
objects and their documentation. `R` packages contain code, data, and documentation
in a standardized format that can be installed by `R` users via a software repository,
such as CRAN (Comprehensive R Archive Network) or GitHub, which makes them an 
adroit medium to distribute analysis-ready data. 

Given the level of interest in active travel [e.g., @mccurdySupport2023], reducing
the barriers to using data contained in rich, but difficult to access and use surveys,
such as Canada's GSSs, is a worthy endeavour that can only improve data-driven 
decisions in transportation, urban, and health policy. 

The rest of this paper discusses the sources of data, and the process implemented
to retrieve and package them. Then, we explain how to use the package and show
some selected examples of analysis to whet the imagination of potential users.
This ODP provides not only data that are easy to use, but also all the code and 
documentation that make this a reproducible research project. In summary, {ActiveCA}
aims to implement and inspire the best principles of open spatial sciences 
[@paez_open_2021; @brunsdon_opening_2021].

# General Social Survey (GSS) collection

Statistics Canada [-@statisticscanada2024] conducts GSS surveys to obtain data 
on social trends to track changes in Canadians' living conditions and well-being
over time. The series of survey on time use are used to understand how Canadian
residents spend and manage their time, and what factors contribute to their 
happiness and stress. The GSS program was created in 1985, and is serialized to 
provide a collection of annual, representative cross-sectional surveys.

The topics of the survey cycle every few years to cover topics that include family,
health, social identity, and every five to seven years time use. The first Canadian
time use survey done as part of the GSS program was conducted in 1986, and the 
most recent was completed in 2015. These Time Use Surveys [@statisticscanada2022]
collect data on respondents' participation and time spent on a wide range of 
everyday activities using a 24-hour retrospective diary, with information on the 
location of these activities (e.g. at home, at work, etc.) and, for non-personal
activities, the people who were present with the respondent at the time of the 
activity. In addition, time-use surveys also cover topics related to leisure time,
work-life balance, health, commuting, culture and sports, and many others.

The Public Use Microdata are released by Statistics Canada in two files: a 
_Main File_ and an _Episode File_. The files are linked by keys that identify 
households, individuals, and episodes (i.e., activities) conducted by individuals.
We discuss these files in more detail in the following section.

## The Main File

The main file of the time use survey compiles a large array of aggregated data, 
summarizing the answers to the questionnaire that describe households and 
individuals, as well as derived variables that summarize the respondents' use of 
time use across different activities, locations, and social interactions. This 
file documents the time and duration that respondents allocate to each activity 
and location. The Main File provides a overview of daily routines and social 
dynamics, not focusing on individual activity episodes. Additionally, this file 
categorizes activities into bigger groups and subcategories, facilitating the 
data's analytical utility with additional metrics such as total transit time, time 
spent with household members, and counts of activities and episodes.

Table \ref{tab:main-2015-unprocessed} shows the first ten rows and first six variables of the GSS PUMF 2015 main file (Cycle 29). Each row in the table correspond to a survey respondent, while the columns refer the following information: record identification (`PUMFID`), the person's weight (`WGHT_PER`), the month the survey data was collected (`SURVMNTH`), the respondent's age group (`AGEGR10`), the respondent's sex (`SEX`), and the respondent's marital status (`MARSTAT`).

The main file of the 2015 GSS surveys includes a total of 17,390 respondents, representing `r sum(gss_m_2015$WGHT_PER)` individuals and 848 variables.  For discrete variables, Statistics Canada has assigned specific codes to the possible values, with each code accompanied by a label. For instance, in the case of the variable `SURVMNTH`, a value of `1` means `January 2016`, 2 means `February 2016`, 3 corresponds to `March 2016`, and so on. 

As shown in Table \ref{tab:main-2015-unprocessed}, the variables are not labeled. Adittionaly, the format of the tables (comma-separated values) does not allow for the specification of variable types (whether a variable is continuous or discrete), which can lead to mistakes analysts who have limited experience working with PUMFs.

```{r gss-main-file-2015}
main_2015_unprocessed <- gss_m_2015[1:10, 1:6]  %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(gss_m_2015[1:10, 1:6]))),
    caption = "\\label{tab:main-2015-unprocessed}Visualization of the first ten lines and first six columns of the main file of the 2015 GSS.") %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 8) %>%
  footnote(general = c("Legend: `PUMFID`: record identification. `WGHT_PER`:  person weight. `SURVMNTH`: survey month of data collection. `AGEGR10`: age group of the respondent. `SEX`: sex of the respondent. `MARSTAT`: marital status of the respondent."), threeparttable = T)

main_2015_unprocessed
```


## The Episode File

The episode is a much bigger file that records detailed data for each activity 
episode reported by respondents. Each episode represents a single activity and its
duration, and the sum of all episodes throughout the day adds up to 24 hours. Each
entry in this file includes the start and end times of the activity, the duration,
location, and accompanying social context, informing when and where activities 
occurred and with whom. The focus of the Episode File is not on the characteristics
of the respondents, but on the characteristics of the activities, and the data 
are structured around the numerous activity instances that compose a day of the 
respondent. Although respondent-specific characteristics are not included within
the episode file, it is possible to link the main file and the episode file by 
using a key present in both the Main and Episode Files.

Similar to Table \ref{tab:main-2015-unprocessed}, which displayed an example of the main file structure, Table \ref{tab:ep-2015-unprocessed} presents the first seven episodes for the record identification number `10041` and some variables from the GSS PUMF 2015 episode file (Cycle 29). Each row in the table corresponds to an episode associated with the specified record identification (`PUMFID = 10041`), including the episode's weight (`WGHT_EPI`), episode number (`EPINO`), activity code (`TUI_01`), episode duration (`DURATION`), and episode location (`LOCATION`).

In total, the episode file of the 2015 GSS surveys contains 274,108 records, representing `r sum(gss_e_2015$WGHT_EPI)` episodes and 527 variables detailing the episodes. Similar to the main file, Statistics Canada has created codes for the discrete variables, with each value corresponding to a label.

In the case illustrated in Table \ref{tab:ep-2015-unprocessed}, this respondent began the diary description by sleeping at home (`TUI_01 = 1` and `LOCATION = 300`) for 210 minutes, followed by 40 minutes of personal hygiene (`TUI_01 = 2`). The respondent then spent 15 minutes on personal care activities, such as getting ready for school, supervising homework, reading, playing, reprimanding, or providing educational or emotional support, as indicated by `TUI_01 = 27`. Next, they recorded a travel episode, walking for 15 minutes (`TUI_01 = 7` and `LOCATION = 315`), where both the origin and destination were their home. Such trips, where the journey starts and finishes at home, can be classified as recreational or leisure trips. Next, the respondent spent 3 hours searching for a job (`TUI_01 = 9`), took a 15-minute lunch break (`TUI_01 = 6`), and then cleaned the house (`TUI_01 = 18`) for two hours. Table \ref{tab:ep-2015-unprocessed} displays only six variables out of the 527 available. As shown, since the dataset does not label the variable values, decoding them can be both time-consuming and challenging.

```{r gss-epi-file-2015}
ep_2015_unprocessed <- gss_e_2015 |>
  filter(PUMFID == 10041 & EPINO <= 7) %>%
  dplyr::select(PUMFID, EPINO,WGHT_EPI,TUI_01, DURATION, LOCATION) %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(gss_m_2015[1:10, 1:6]))),
    caption = "\\label{tab:ep-2015-unprocessed}Visualization of the seven first episodes of the record number `10041`.") %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 8) %>%
  footnote(general = c("Legend: `PUMFID`: record identification. `EPINO`: episode number. WGHT_EPI: episode's weight. TUI_01: activity code. DURATION: episode's duration. LOCATION: episode's location."), threeparttable = T)

ep_2015_unprocessed
```

# Data extraction

For each selected cycle of the GSS surveys, we reviewed the episode files to identify episodes of movement that involved walking or cycling. This allowed us to select the activities immediately before and after the movement episode. After that, we labeled the code variables with their appropriate descriptions, identifying each origin and destination, mode of travel, time spent in the active trip, as well the province and urban classification of the episode.

The active trips (walking and cycling) were identified by their corresponding activity codes, accounting for differences between the survey cycles. Identifying the preceding and succeeding activities of each activity episode helps to understand the motivation for the trip and also determine the origin and destination of the trips.

For each GSS main file, we selected socioeconomic variables to help profile the individuals engaged in active trip episodes. We included key socioeconomic variables such as the respondent’s age group, sex, marital status, and number of children, among others. After this, as we did with the episode files, we labeled the code variables with their appropriate descriptions. 

# How to use `ActiveCA`

This section presents some potential applications of the `ActiveCA` R package. In fact, we expect that the application of this package to extend beyond our pre-imagined range of uses. 

To start the demonstration, it is first necessary to install the package. The code chunk below demonstrates how to install the `ActiveCA` package in R:

```{r instal-ActiveCA, echo=TRUE}
if(!require("ActiveCA", character.only = TRUE)) {
      remotes::install_github("dias-bruno/ActiveCA")
}
```

After installing the `ActiveCA` R package, you can load it using the following code:

```{r load-ActiveCA, echo=TRUE}
library(ActiveCA)
```

By running `?ActiveCA` in `R`, you can access the complete package documentation. The documentation includes a description of the package, information about the authors and maintainers, and an overview of all pre-processed data sets included in the package.

Figure \ref{fig:walking_documentation} displays the documentation for the walking episodes from the 2015 GSS (`walking_2015.rda`). The documentation provides a brief description of the dataset, instructions on how to load the package, as well as details about the file format and descriptions of all variables (already labeled).

```{r walking_documentation, echo=FALSE, out.width="100%", fig.cap=paste0("Documentation for the dataset of walking episodes from 2015."), fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/paper/Manuscript-figures/walking-2015-documentation.png"))
```

The chunk below shows how to load the walking episodes from the 2015 GSS (Cycle 29):

```{r load-walking-2015-episodes, echo=TRUE}
data(walking_2015)
```

The GSS surveys apply a probability sampling methodology, in which each episode or person selected in the sample represents several other episodes or persons not in the sample. The number of episodes and persons represented by a episode or person is determined by the weight or weighting factor. Because of this, every estimates of the number of episodes or persons need to be calculated applying the corresponding weighting factors. 

For instance, if someone wants to calculate the percentage of respondents from the 2015 GSS survey with active travel episodes, it is necessary to account for the person's weights. In 2015, the weight variable is represented by `WGHT_PER.` The code chunk below demonstrates how to obtain the percentage of people with active travel episodes by age group. It uses the dplyr package to manipulate the data.

The process begins by creating a dataset that sums the population by age group. Then, it joins the 2015 episodes with the 2015 main file. Note that in both operations, the code sums the person weight variable (`WGHT_PER`) to obtain the correct population values. After this, a new dataset, `Active_percentage`, is created by merging both previous datasets. The percentage of active travel episodes by age group is calculated by dividing the total population by the population with active trip episodes, then multiplying by 100.

The result shows that the age group with the highest share of active trips is those between 15 and 20 years old, with almost 37%, followed by those between 25 and 34 years old with around 33%. There is a significant drop in percentage for the following groups, with the percentage falling to between 15% and 18% for the remaining age groups.

```{r percentages-act, echo=TRUE}
# Load the dplyr library for data manipulation
library('dplyr')

# Load the episodes dataset
data(gss_episodes) 

# Calculate the total population for each age group
Total_population <- gss_main_2015 %>% 
  group_by(AGEGR10) %>% 
  summarise(Total_population  = sum(WGHT_PER))

# Calculate the active population for each age group
Active_population <- gss_episodes %>% 
      filter(YEAR == 2015) %>% 
  left_join(gss_main_2015, by = c("PUMFID"="PUMFID")) %>% 
  group_by(AGEGR10) %>% 
  summarise(Active_population  = sum(WGHT_PER))

# Combine total and active population and calculate the percentage
Active_percentage <- Total_population %>% 
  left_join(Active_population, by = c("AGEGR10" = "AGEGR10")) %>%
  mutate(Percentage = round(Active_population/Total_population  * 100, 2))

# Display the final result
Active_percentage
```

## Processed data set

```{r processed-files, include=FALSE}
df_main_processed <- data.frame(
  'Survey' = c("Main","Main","Main","Main","Main","Main"),
  'Year' = c(2015, 2010, 2005, 1998, 1992, 1986),
  'Count' = c(nrow(gss_main_2015),
              nrow(gss_main_2010),
              nrow(gss_main_2005),
              nrow(gss_main_1998),
              nrow(gss_main_1992),
              nrow(gss_main_1986)),
  'Weighted' = c(sum(gss_main_2015$WGHT_PER),
              sum(gss_main_2010$WGHT_PER),
              sum(gss_main_2005$WGHT_PER),
              sum(gss_main_1998$WGHTFIN),
              sum(gss_main_1992$FWGHT),
              sum(gss_main_1986$FWGT_OS/10000)))


df_ep_processed <- gss_episodes %>% 
  group_by(YEAR) %>%
  summarise(Survey = 'Episode', 
            Count = n(), 
            Weighted = sum(WGHT_EPI)) %>%
  rename(Year = YEAR) %>%
  dplyr::select(Survey, Year, Count, Weighted) %>% 
  arrange(-Year)


df_processed <- rbind(df_main_processed,df_ep_processed)
```


Table \ref{tab:processed-obs} displays the total number of observations processed for main and episode files. For the main files, a total of `r sum(df_main_processed$Count)` observations were processed, referring to all observations from the Time Use Surveys from 1986 to 2015, that together represents more of `r sum(df_main_processed$Weighted)` respondents (`r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '2015',]$Weighted)` for 2015, `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '2010',]$Weighted)` for 2010, `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '2005',]$Weighted)` for 2005, `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '1998',]$Weighted)` for 1998, `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '1992',]$Weighted)` for 1992, and  for 2005, `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '1998',]$Weighted)` for 1998, and `r sum(df_main_processed[df_main_processed$Survey == 'Main' & df_main_processed$Year == '1992',]$Weighted)` for 1986). Table X also presents the total cases of active trips episodes identified. In total `r sum(df_ep_processed$Count)` observations with register of active travel activity. Together, these observations account for `r sum(df_ep_processed$Weighted)` episodes (`r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '2015',]$Weighted)` for 2015, `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '2010',]$Weighted)` for 2010, `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '2005',]$Weighted)` for 2005, `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '1998',]$Weighted)` for 1998, `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '1992',]$Weighted)` for 1992, and  for 2005, `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '1998',]$Weighted)` for 1998, and `r sum(df_ep_processed[df_ep_processed$Survey == 'Episodes' & df_ep_processed$Year == '1992',]$Weighted)` for 1986).

```{r table_df_processed}

table_df_processed <- df_processed %>%
  kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
        caption = "\\label{tab:processed-obs}Total number and weighted sum of observations processed.") %>%
  kable_styling(full_width = FALSE, font_size = 10) %>%
  add_header_above(c(" " = 2, "Observations" = ncol(df_processed) - 2)) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major")

table_df_processed
```

Table \ref{tab:main-2015-processed} shows the first ten rows and first six variables of the GSS PUMF 2015 main file (Cycle 29), displayed in \ref{tab:main-2015-unprocessed} before our processing. Table \ref{tab:ep-2015-processed} presents the walking episodes for the record identification number `10041` from the GSS PUMF 2015 episode file (Cycle 29), previously displayed in Table \ref{tab:ep-2015-unprocessed}. Only active travel episodes appear in Table \ref{tab:ep-2015-processed} since the observations were filtered to select cases with walking or cycling episodes. For both cases, Tables \ref{tab:main-2015-processed} and \ref{tab:ep-2015-processed} contain labeled variables, facilitating the interpretation of the data.

```{r gss-processed-file-2015, echo=FALSE, cache=FALSE}
main_2015_processed <- gss_main_2015[1:10, 1:6]  %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(gss_m_2015[1:10, 1:6]))),
    caption = "\\label{tab:main-2015-processed}Visualization of the first ten lines and first six columns of the main file of the 2015 GSS.") %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 8) %>%
  footnote(general = c("Legend: `PUMFID`: record identification. `WGHT_PER`:  person weight. `SURVMNTH`: survey month of data collection. `AGEGR10`: age group of the respondent. `SEX`: sex of the respondent. `MARSTAT`: marital status of the respondent."), threeparttable = T)

main_2015_processed

ep_2015_unprocessed <- gss_episodes_renamed |>
  filter(PUMFID == 10041 & YEAR == 2015) %>%
  dplyr::select(PUMFID, WGHT_EPI, act_label, DURATION, orig_label, dest_label, MODE) %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    caption = "\\label{tab:ep-2015-processed}Visualization of active travel episodes of the record number `10041` for the 2015 GSS survey.", 
       col.names = c("PUMFID", "WGHT_EPI","Activity","Duration","Origin", "Destination", "Mode")) %>% 
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 8) %>%
  footnote(general = c("Legend: `PUMFID`: record identification. `EPINO`: episode number. WGHT_EPI: episode's weight. TUI_01: activity code. DURATION: episode's duration. LOCATION: episode's location."), threeparttable = T)

ep_2015_unprocessed
```

## Descriptive statistics

Considering GSS Cycles analyzed, we identified `r nrow(gss_episodes)` episodes that recorded active travel episodes, with trip duration ranging from 0 to 900 minutes, to twelve different destinations. `ActiveCA` includes all these episodes ready for analysis. Table \ref{tab:table-01} presents descriptive statistics on walking and cycling trips between 1986 and 2015, with measures of trip duration in minutes: maximum (max), mean, median, and minimum (min). The 1986 survey did not
include bicycle trips.

```{r table-01, echo=FALSE, cache=FALSE}
# Calculate min, mean, and max statistic (duration)
stats_data <- gss_episodes_renamed %>%
  group_by(YEAR, MODE) %>%
  dplyr::summarise(
    min = min(DURATION),
    mean = sum(DURATION * WGHT_EPI)/sum(WGHT_EPI),
    median =  Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    std = sd(DURATION),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(min, mean, median, max, std), names_to = "Statistic", values_to = "Value") %>%
  pivot_wider(names_from = YEAR, values_from = Value)

# Combine counts and stats into one data frame
stats_data <- stats_data %>%
  mutate(MODE = factor(MODE, levels = c("Walking", "Cycling"))) %>%
  arrange(MODE, Statistic) %>%
  mutate(across(where(is.numeric), ~ round(.x, 0)))

# Rename the 'MODE' column to 'Mode' before generating the table
stats_data <- stats_data %>%
  rename(Mode = MODE) %>%
  dplyr::select(Mode, Statistic, everything()) %>% 
   mutate(Statistic = case_when(
    Statistic == "max" ~ "Maximum",
    Statistic == "min" ~ "Minimum",
    Statistic == "mean" ~ "Mean",
    Statistic == "median" ~ "Median",
    Statistic == "std" ~ "Standard deviation",
    TRUE ~ Statistic))
  
# Creating a latex table
styled_ch03_table_01 <- stats_data %>%
  kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
        caption = "\\label{tab:table-01}Descriptive statistics for episodes with active transport records",  
        align = c('l', 'l', rep('c', ncol(stats_data) - 2))) %>%
  kable_styling(full_width = FALSE, font_size = 10) %>%
  column_spec(1, bold = TRUE) %>%
  add_header_above(c(" " = 2, "Year" = ncol(stats_data) - 2)) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major")

# Print the table
styled_ch03_table_01
```

Table \ref{tab:table-01} shows that, in general, the median values for walking trips is 10 minutes, except for 1998 when the median was 5 minutes. In the case of cycling trips, the duration fluctuated over the years, ranging from 10 to 20 minutes. The table also highlights very high maximum values, particularly for walking trips, with recorded episodes exceeding 4 hours in all cases.

Table \ref{tab:table-02} and \ref{tab:table-03} provide descriptive
statistics for the two modes of transportation, split by destination
categories, from 1986 to 1998 and from 2005 to 2015, respectively. In
Table \ref{tab:table-02}, one can observed that in 1986 and 1992,
walking trips destined for `home` had the highest medians. However, by
1998, the highest medians shifted to trips to `work or school`, a
transition that also occurred for cycling trips between 1992 and 1998.
Table \ref{tab:table-03} indicates that the median duration for walking trips to
`home` and `work or school` remained at 10 minutes.

```{r table-02, echo=FALSE, cache=FALSE, warning=FALSE, results="asis"}
# Filter for selected years and calculate statistics of trip duration
episodes_stats_before <- gss_episodes %>%
  filter(YEAR < 2005) %>%
  group_by(YEAR, dest_label, MODE) %>%
  dplyr::summarise(
    count = sum(WGHT_EPI),
    min = min(DURATION),
    median = Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages of trips by mode/year 
total_counts <- episodes_stats_before %>% 
  group_by(YEAR, MODE) %>% 
  summarise(total_count = sum(count), 
            .groups = "drop")

episodes_stats_before <- left_join(episodes_stats_before, total_counts, by = c("YEAR", "MODE"))

episodes_stats_before$Percentage <- round((episodes_stats_before$count / episodes_stats_before$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_before %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  )  %>% 
  arrange(MODE, dest_label, desc(Percentage_1998))

wide_data <- wide_data %>%
 dplyr::select(
    MODE, dest_label,
    min_1986, median_1986, max_1986, Percentage_1986,
    min_1992, median_1992, max_1992, Percentage_1992,
    min_1998, median_1998, max_1998, Percentage_1998
  ) %>% 
  arrange(MODE, dest_label)

# Latex table
styled_ch03_table_02 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:table-02}Comparison of travel statistics by mode and destination: 1986, 1992, 1998",
    col.names = c("Destination", "Mode","Min","Med","Max", "(%)", "Min","Med","Max", "(%)", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 6) %>%
  # column_spec(1, width = "1cm") %>%  # Set width of 'Dest' column to 1.5cm
  # column_spec(2:14, width = "0.5cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "1986" = 4, "1992" = 4, "1998" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  column_spec(6, border_right = TRUE) %>%
  column_spec(10, border_right = TRUE) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>% 
  footnote(general = c("'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_ch03_table_02 
```

```{r table-03,echo=FALSE, cache=FALSE, warning=FALSE}
# Selecting surveys after 2000 and calculating trip duration statistics 
episodes_stats_after <- gss_episodes_renamed %>%
  filter(YEAR > 2000) %>%
  group_by(YEAR, dest_label, MODE) %>%
   dplyr::summarise(
    count = sum(WGHT_EPI),
    min = min(DURATION),
    median = Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages of trips by mode/year
total_counts <- episodes_stats_after %>% group_by(YEAR, MODE) %>% summarise(total_count = sum(count), .groups = "drop")
episodes_stats_after <- left_join(episodes_stats_after, total_counts, by = c("YEAR", "MODE"))
episodes_stats_after$Percentage <- round((episodes_stats_after$count / episodes_stats_after$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_after %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  ) %>%
 dplyr::select(
    MODE, dest_label,
    min_2005, median_2005, max_2005, Percentage_2005,
    min_2010, median_2010, max_2010, Percentage_2010,
    min_2015, median_2015, max_2015, Percentage_2015
  ) %>% 
  arrange(MODE, dest_label)

# Latex table
styled_ch03_table_03 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:table-03}Comparison of travel statistics by mode and destination: 2005, 2010, 2015",
    col.names = c("Destination", "Mode","Min","Med","Max", "(%)", "Min","Med","Max", "(%)", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                font_size = 6) %>%
  #column_spec(1, width = "2cm") %>%  # Set width of 'Dest' column to 1.5cm
  #column_spec(2:14, width = "0.4cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "2005" = 4, "2010" = 4, "2015" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  column_spec(6, border_right = TRUE) %>%
  column_spec(10, border_right = TRUE) %>% 
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>% 
  footnote(general = c("'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_ch03_table_03
```

{ActiveCA} also enables visual analysis of active travel in Canada using traditional exploratory data analysis techniques. Figures \ref{fig:figure-01} and \ref{fig:figure-02} show walking and cycling trips from 1992 and 2015 through heat maps. These maps use color gradients to represent the percentage of trips between various origins and destinations, with darker colors indicating higher percentages and lighter colors representing less frequent routes. For conciseness, we omitted the heat maps for the other years analyzed.

In 1992, walking trips with `home` as both the origin and destination
made up the majority, accounting for about 30% of all walking trips.
These trips often involved leisure activities, like short walks or dog
walking. Following this, trips from `home` to `work or school` comprised
18% of walking trips. Overall, `home` emerged as a crucial hub, either
as an origin or destination, with only 5% of trips not involving `home.`
By 2015, `home` remained a significant node, but new locations
distributed the proportion of trips to areas not considered in 1992. In
2015, the highest proportion of trips were from `home` to
`work or school` (12%) and vice versa (11%). `home` to `home` accounted
for 8% of trips, and `grocery stores` became a notable destination for
those leaving `home` (6%), surpassing trips to `other's home` (4%).

```{r heatmaps, echo=FALSE, cache=FALSE, include=FALSE}

# Creating heatmaps for the years of 1992 and 2015
gss_heatmap <- gss_episodes_renamed %>%
  mutate(WGHT_EPI = ifelse(is.na(WGHT_EPI), 1, WGHT_EPI)) %>% 
  filter(YEAR %in% c(1992,2015))

for(year in unique(gss_heatmap$YEAR)){
  
  for(mode in unique(gss_heatmap$MODE)){
    
    trip_counts <- gss_heatmap %>%
      filter(YEAR == year, MODE == mode) %>% 
      group_by(orig_label, dest_label) %>%
        dplyr::summarise(count_each_trip = n(), 
                weighted_count = sum(WGHT_EPI), .groups = "drop")

      # Calculate the total weighted count
      total_weighted_count <- sum(trip_counts$weighted_count)
      
      # Calculate percentages and round to 2 decimal places
      trip_counts <- trip_counts %>%
        mutate(percentage = round((weighted_count / total_weighted_count) * 100, 2))

      # Reshape data for heatmap
      heatmap_data <- dcast(trip_counts, orig_label ~ dest_label, value.var = "percentage")

      # Convert the data frame to a matrix for the heatmap
      heatmap_matrix <- as.matrix(heatmap_data[,-1]) # Remove the first column (orig)
      rownames(heatmap_matrix) <- heatmap_data$orig # Assign row names from the 'orig' column

      # Melt the matrix for use with ggplot
      heatmap_melted <- melt(heatmap_matrix, varnames = c("Origin", "Destination"))

      # Define the order of destinations 
      destination_order <- c("Home", "Work or school", "Grocery store", 
                             "Others' home", "Outdoors", "Neighbourhood", 
                             "Cultural venues", "Place of worship", 
                             "Restaurant", "Sport area", "Business")
      
      # Heatmap for every combination of year and mode
      assign(paste0("heatmap_plot_", year, "_", mode),
               ggplot(heatmap_melted, aes(x = Destination, y = Origin, fill = value)) +
                  geom_tile(color = "white") +
                  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlOrRd"), 
                                       na.value = "gray95", 
                                       limits = c(0, ceiling(max(heatmap_melted$value, na.rm = TRUE))), 
                                       breaks =  c(0, ceiling(max(heatmap_melted$value, na.rm = TRUE))), 
                                       labels = c("0%", paste0(ceiling(max(heatmap_melted$value, na.rm = TRUE)), "%"))) +
                  #geom_text(data = subset(heatmap_melted, !is.na(value) & value >= 0), 
                  #    aes(label = round(value)), 
                  #    size = 4, color = "black") +
                  labs(x = "Destination", y = "Origin", fill = "Percentage", caption = year) +
                  theme_minimal() +
                  theme(
                  axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
                  axis.text.y = element_text(size = 16, margin = margin(l = 15)),
                  axis.title = element_text(size = 16),
                  legend.title = element_text(size = 16, margin = margin(b = 15)), 
                  legend.text = element_text(size = 16),
                  plot.caption = element_text(hjust = 0.5, size = 20, face = "bold", margin = margin(t = 28.35, unit = "pt")))
             
             ) 
  }
} 
```

```{r make-figs, include=FALSE}
# Fixing the size of the heatmaps 
heatmap_plot_2015_Walking <- heatmap_plot_2015_Walking +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_2015_Cycling <- heatmap_plot_2015_Cycling +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_1992_Cycling <- heatmap_plot_1992_Cycling +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_1992_Walking <- heatmap_plot_1992_Walking +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

# Combine the plots with adjusted spacing
walking_hm_fig <- cowplot::plot_grid(heatmap_plot_1992_Walking, heatmap_plot_2015_Walking, ncol = 2, align = 'hv',  rel_widths = c(1, 1))

# Save the combined plot to a file
ggsave(file = paste0(here::here(),"/paper/Manuscript-figures/walking_hm_fig.jpg"), 
       plot = walking_hm_fig,
       width = 17, 
       height = 8, 
       units = "in", 
       dpi = 300)

# Combine the plots with adjusted spacing
cycling_hm_fig <- cowplot::plot_grid(heatmap_plot_1992_Cycling, heatmap_plot_2015_Cycling, ncol = 2, align = 'hv',  rel_widths = c(1, 1))

# Save the combined plot to a file
ggsave(file = paste0(here::here(),"/paper/Manuscript-figures/cycling_hm_fig.jpg"), 
       plot = cycling_hm_fig,
       width = 17, 
       height = 8, 
       units = "in", 
       dpi = 300)
```

```{r figure-01, echo=FALSE, out.width="100%", fig.cap="Percentage of walking trips categorized by origin and destination", fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/paper/Manuscript-figures/walking_hm_fig.jpg"))
```

For cycling trips, Figure \ref{fig:figure-02}, shows that in 1992, when
this mode of transportation was first included as an activity, the
majority of trips were from `home` to `work or school`, accounting for
about 25% of cases. This pattern remained in 2015, with these trips
representing 30% of the cases. However, a notable change occurred in
`home` to `home` trips, which decreased significantly from 19% in 1992
to 5% in 2015.

```{r  figure-02, echo=FALSE, out.width="100%", fig.cap="Percentage of cycling trips categorized by origin and destination", fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/paper/Manuscript-figures/cycling_hm_fig.jpg"))
```

`ActiveCA` also enables obtaining insights from the main processed files. Figure \ref{fig:figure-stress} present how the level of stress varied among respondents depending on their marital status in 2015. According to this plot, married respondents reported the highest level of stress, with 17% of possible cases. 

```{r main_stress_figure}
main_stress_figure <- gss_main_2015 %>%
  filter(!is.na(MARSTAT), !is.na(GTU_110)) %>%
  group_by(MARSTAT, GTU_110) %>%
  dplyr::summarise(n = sum(WGHT_PER), .groups = "drop") %>%
  mutate(percentage = n / sum(n) * 100) %>%
  ungroup() %>%
  ggplot(aes(x = MARSTAT,
    y = GTU_110)) +
    geom_tile(aes(fill = percentage)) +
    labs(x = "Marital status of the respondent",
    y = "How often do you feel rushed?",
    fill = "Percentage (%)") + 
    geom_text(aes(label = round(percentage)), color = "black", size = 3) + 
    theme_bw() + 
    scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Save the combined plot to a file
ggsave(file = paste0(here::here(),"/paper/Manuscript-figures/main_stress_figure.jpg"), 
       plot = main_stress_figure,
       width = 15, 
       height = 10, 
       units = "cm", 
       dpi = 300)
```

```{r figure-stress, echo=FALSE, out.width="100%", fig.cap=paste0("Level of stress among respondents of different marital statuses (2015)."), fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/paper/Manuscript-figures/main_stress_figure.jpg"))
```

# Python integration

 

# Concluding remarks

This paper presents `ActiveCA`, an open data product that provides analysis-ready 
data from Cycles 2 (1986), 7 (1992), 12 (1998), 19 (2005), 24 (2010), and 29 (2015) 
of the GSS surveys on active travel in Canada. In the form of an `R` data package, 
{ActiveCA} was developed after collecting, cleaning, and processing the survey data, 
providing information on origins, destinations, and duration of active travel, as
well other information. 

It is important to remark that the present version of {ActiveCA} covers all Canadian
time use surveys up to 2015. While the most recent time use survey was carried out
in 2022 [@wray2024], the Public Use Microdata Files are currently unavailable, and
at the moment it is estimated that they will only be published in the later part
of 2025. The `R` package will be updated once these files become available.

The value of {ActiveCA} lies in its transparency, accessibility, and ease of use,
which facilitates the addition of complementary data sets in the future. `R` users
can seamlessly explore GSS walking and cycling episodes, 
with the option to suggest enhancements to the package as needed. This article adopts
the structure proposed by Anastasia and Páez [-@soukhov2023], whose work provided
essential guidance for the creation of this package. Similarly, we aim to contribute
to the academic community by promoting transparent research practices that encourage
replication and innovation in related fields. We believe that {ActiveCA} will serve
as a basis for further research on GSS and for the integration of additional data by
the authors or the wider open source community.

# Declaration of Conflicting Interests

The author(s) declared no potential conflicts of interest with respect
to the research, authorship, and/or publication of this article.

# Funding

The author(s) disclosed receipt of the following financial support for
the research, authorship, and/or publication of this article: This work
was supported by the Social Sciences and Humanities Research Council of
Canada (*More description about the funding source after the review
process*).

# ORCID

Author 1 


Author 2 


Author 3


# Data availability statement

The {ActiveCA} R data package can be found and installed on Github
(*link*).

# References {#references .unnumbered}
