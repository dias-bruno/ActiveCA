---
title: "ActiveCA: an open data product to obtain impedance functions for active transportation modes in Canada"
author:
  - name: "Anon1"
    email: "Anon1@anon.org"
    affiliation: CODE
    footnote: 1
  - name: "Anon2"
    email: "Anon2@anon.org"
    affiliation: CODE
  - name: "Anon3"
    email: "Anon3@anon.org"
    affiliation: CODE
address:
  - code: CODE
    address: "Some school"
footnote:
  - code: 1
    text: "Corresponding Author"
abstract: 
  "This article describes and visualizes the data contained in the {ActiveCA} R data package. {ActiveCA} contains open data products designed to obtain impedance functions for active transportation modes in Canada, retrieved from the General Social Survey collections from 1986 to 2015. The package provides data tables on walking and cycling episodes, detailing the trip origins, destinations, and duration of each episode. The origin and destination categories covers a wide variety of locations, such as home, work or school, libraries, museums, restaurants, bars, sports centers, health clinics, place of worship, and others. Addittionally, the package includes details on the respondent's region characteristics, specifying wheter they live in a metropolitan area and their province of residency. {ActiveCA} enables users to calculate the average travel time for each origin-destination combination for each survey year, considering the two active transportation modes: walking and cycling. For each Census Metropolitan and Agglomeration Area, we estimated distance decay curves (impedance functions) for each origin-destination. The package will continue to expand with contributions from the authors and the broader community through requests in the future. {ActiveCA} is freely accessible for exploration and download from the associated Github repository, where the documentation and code involved in creating and manipulating data and all open data products are detailed." 
    
keywords: Active; mobility; walking; cycling; travel time; impedance; transportation; R 
classoption:
  - Royal
  - times
bibliography: bibfile.bib
bibliographystyle: sageh
output:
  rticles::sage_article:
    keep_tex: yes
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  warning = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r install-data-package, include=FALSE}
if (!require("ActiveCA", character.only = TRUE)) {
      remotes::install_github("dias-bruno/ActiveCA",
                        build_vignettes = TRUE)
}

rm(list=ls())
```

```{r load-packages, include=FALSE, cache=FALSE}
library(ActiveCA)
library(here)
library(dplyr)
library(tidyr)
# library(fitdistrplus)
library(ggplot2)
library(kableExtra)
library(reshape2)

# library(patchwork)
# library(sf)
# library(scales)
# library(stats)
# library(ggspatial)
# library(shadowtext)
# library(tmap)
# library(ggpmisc)
```

```{r load-data, include = FALSE}
load(paste0(here(), "/data/gss_episodes.Rda"))
load(paste0(here(), "/data/gss_impedances.Rda"))


```

# Introduction

This manuscript presents the open data product {ActiveCA}. Open data products (ODPs) are the outcome of a transparent process that transforms raw data (open or not) into analysis-ready data, in which all stages of development follow open principles. ODPs differ from general open data due to their high utility, added value and open availability. The product presented in this document is an `R` data package that currently consists of processed data tables retrieved from the General Social Survey (GSS) collections from 1986 to 2015, to obtain impedance functions for active transportation modes in Canada.

To create this `R` data package, we collected the GSS surveys, cleaned them and processed them to make it ready for analysis. An `R` data package contains code, data and documentation in a standardized collection format that can be installed by `R` users via a centralized software repository, such as CRAN (Comprehensive R Archive Network) and GitHub. Although the GSS surveys are publicly sourced and managed by Statistic Canada, preparing them for analysis can be time-consuming, tedious and perhaps not even possible for those who try, due to a lack of documentation or prior knowledge. 

The aim of this paper is to walk readers through the data sets and invite others to experiment in its uses and applications. {ActiveCA} is freely available on GitHub for all to install and freely use in the spirit of open and reproducible research. Although {ActiveCA} was designed to obtain impedance functions, we admit and hope that its use can be adopted in various applications that even go beyond the range of possibilities we have imagined. Not only the data, but also all the code documenting the processing methodology is available for consultation and evaluation in its repository. This package contributes to reducing the barrier to using the information contained in GSS surveys to provide data-driven decisions in transportation analysis. 

# General Social Survey (GSS) collection 

In Canada, Statistics Canada produces the General Social Surveys (GSS)
to collect data on social trends in order to track changes in the living
conditions of Canadians and well-being over time. This survey tracks
changes in time and it is used to understand how Canadians spend and
manage their time and what factors contribute to their happiness and
stress. The survey was created in 1985 as a series of independent,
annual, cross-sectional surveys, each covering one topic in depth.
Caregiving, families, time use, social identity, volunteering, and
victimization are among the current themes of the GSS.

The six survey themes listed above are repeated every five years. In
addition to the central topic, each cycle includes new content that
addresses emerging and policy-relevant issues, collecting detailed
socio-demographic information, such as age, gender, education, religion,
ethnicity, income, etc. Time-use surveys collect data on all human
activities and can inform a wide range of policies. In particular, three
key themes have been identified as essential for policymaking and for
which no other data source is adequate: unpaid work and non-market
production, well-being, and gender equality. Leisure time, work-life
balance, health, commuting, culture, and sports are among the other
topics covered by time-use surveys. In addition, statistics Canada has
been conducting time-use surveys at five to seven year intervals since
1986, with the most recent being in 2015 (1986, 1992, 1998, 2005, 2010,
and 2015). The time use collects information on participation of
respondents and time spent on a wide range of day-to-day activities
using a 24-hour retrospective diary. Also, information is collected on
the location of these activities (e.g., at home, at work, etc.) and, for
non-personal activities, the people who were present with the respondent
at the time of the activity.

## The Main File

The Main File compiles an large array of aggregated data, summarizing
the answers to the questionnaire and derived variables that summarize
the respondents' time use across different activities, locations, and
social interactions. This file documents the time and duration that
respondents allocate to each activity and location. The Main File
provides a overview of daily routines and social dynamics, not focusing
on individual activity episodes. Additionally, this file categorizes
activities into bigger groups and subcategories, enhancing the data's
analytical utility with additional metrics such as total transit time,
duration spent with household members, and counts of activities and
episodes. This file is aggregated and prohibits the direct association
between specific activities with particular locations or companions.

## The Episode File

The Episode File records detailed data for each activity episode
reported by respondents. Each episode entry includes the start and end
times, duration, location, and accompanying social context, informing
when and where activities occurred and with whom. The file distinguishes
itself by focusing on individual episodes rather than respondents, with
the data structured around the numerous activity instances that compose
a respondent's day. Although respondent-specific characteristics are not
included within the Episode File, it is possible to link the Main File
and the Episode File by using an identifiable variable present in both
data sets.

# Average travel times

```{r ch03-make-table-01, echo=FALSE, cache=FALSE}

# Calculate the count of trips for each mode and year
# Summarize counts by year and mode
episodes_counts <- gss_episodes %>%
  group_by(YEAR, MODE) %>%
  summarise(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = YEAR, values_from = count)

# Calculate min, mean, and max statistics
stats_data <- gss_episodes %>%
  group_by(YEAR, MODE) %>%
  summarise(
    min = min(DURATION),
    mean = mean(DURATION),
    median = median(DURATION),
    max = max(DURATION),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(min, mean, median, max), names_to = "Statistic", values_to = "Value") %>%
  pivot_wider(names_from = YEAR, values_from = Value)

# Combine counts and stats into one data frame
final_data <- bind_rows(
  episodes_counts %>% mutate(Statistic = "count"),
  stats_data
) %>%
  mutate(MODE = factor(MODE, levels = c("Walking", "Cycling"))) %>%
  arrange(MODE, Statistic) %>%
  mutate(across(where(is.numeric), ~ round(.x, 0)))

# Rename the 'MODE' column to 'Mode' before generating the table
final_data <- final_data %>%
  rename(Mode = MODE) %>%
  dplyr::select(Mode, Statistic, everything())

# Generate the table with 'Statistic' as the second column
styled_ch03_table_01 <- final_data %>%
  kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
        caption = "\\label{tab:ch03-table-01}Descriptive Analysis of Active Transportation Modes: Walking and Cycling Statistics from 1986 to 2015",  
        align = c('l', 'l', rep('c', ncol(final_data) - 2))) %>%
  kable_styling(full_width = FALSE, font_size = 10) %>%
  column_spec(1, bold = TRUE) %>%
  add_header_above(c(" " = 2, "Year" = ncol(final_data) - 2)) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major")

# Print the table
styled_ch03_table_01
```


```{r ch03-make-table-02, echo=FALSE, cache=FALSE, warning=FALSE, results="asis"}
# Filter for selected years
episodes_stats_before <- gss_episodes %>%
  filter(YEAR < 2005) %>%
  group_by(YEAR, dest_label, MODE) %>%
  summarise(
    count = n(),
    min = min(DURATION),
    median = median(DURATION),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages
total_counts <- episodes_stats_before %>% 
  group_by(YEAR, MODE) %>% 
  summarise(total_count = sum(count), 
            .groups = "drop")

episodes_stats_before <- left_join(episodes_stats_before, total_counts, by = c("YEAR", "MODE"))

episodes_stats_before$Percentage <- round((episodes_stats_before$count / episodes_stats_before$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_before %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  )  %>% 
  arrange(MODE, desc(Percentage_1998))

wide_data <- wide_data %>%
  group_by(MODE) %>%
  mutate(MODE = if_else(row_number() == 2, as.character(MODE), "")) %>%
  ungroup() %>%
 dplyr::select(
    dest_label, MODE,
    min_1986, median_1986, max_1986, Percentage_1986,
    min_1992, median_1992, max_1992, Percentage_1992,
    min_1998, median_1998, max_1998, Percentage_1998
  )

styled_ch03_table_02 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:ch03-table-02}Comparative Trip Stats by Mode and Destination: 1986, 1992, 1998",
    col.names = c("Destination", "Mode*","Min*","Med*","Max*", "(%)*", "Min","Med","Max", "(%)", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 6) %>%
  # column_spec(1, width = "1cm") %>%  # Set width of 'Dest' column to 1.5cm
  # column_spec(2:14, width = "0.5cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "1986" = 4, "1992" = 4, "1998" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  column_spec(6, border_right = TRUE) %>%
  column_spec(10, border_right = TRUE) %>% 
  footnote(general = c("* The symbols used in this table represent the following: 'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_ch03_table_02 
```


```{r ch03-make-table-03,echo=FALSE, cache=FALSE, warning=FALSE}
# Rename certain 'dest_label' values
gss_episodes_renamed <- gss_episodes %>%
  mutate(dest_label = case_when(
    dest_label == "Grocery store, other stores or mall" ~ "Grocery store",
    dest_label == "Restaurant, bar or club" ~ "Restaurant",
    dest_label == "Sports centre, field or arena" ~ "Sport area",
    dest_label == "Medical, dental or other health clinic" ~ "Health clinic",
    dest_label == "In the neighbourhood" ~ "Neighbourhood",
    dest_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ dest_label  # Keep all other values as they are
  ), 
  orig_label = case_when(
    orig_label == "Grocery store, other stores or mall" ~ "Grocery store",
    orig_label == "Restaurant, bar or club" ~ "Restaurant",
    orig_label == "Sports centre, field or arena" ~ "Sport area",
    orig_label == "Medical, dental or other health clinic" ~ "Health clinic",
    orig_label == "In the neighbourhood" ~ "Neighbourhood",
    orig_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ orig_label))

# Filter for walking and cycling trips, selected years, and duration <= 90
episodes_stats_after <- gss_episodes_renamed %>%
  filter(YEAR > 2000) %>%
  group_by(YEAR, dest_label, MODE) %>%
  summarise(
    count = n(),
    min = min(DURATION),
    median = median(DURATION),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages
total_counts <- episodes_stats_after %>% group_by(YEAR, MODE) %>% summarise(total_count = sum(count), .groups = "drop")
episodes_stats_after <- left_join(episodes_stats_after, total_counts, by = c("YEAR", "MODE"))
episodes_stats_after$Percentage <- round((episodes_stats_after$count / episodes_stats_after$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_after %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  ) %>%
 dplyr::select(
    dest_label, MODE,
    min_2005, median_2005, max_2005, Percentage_2005,
    min_2010, median_2010, max_2010, Percentage_2010,
    min_2015, median_2015, max_2015, Percentage_2015
  ) %>% 
  arrange(MODE, desc(Percentage_2015)) %>%
  group_by(MODE) %>%
  mutate(MODE = if_else(row_number() == 2, as.character(MODE), "")) %>%
  ungroup()

styled_ch03_table_03 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:ch03-table-03}Comparative Trip Statistics by Transportation Mode and Destination: 2005, 2010, and 2015",
    col.names = c("Destination", "Mode*","Min*","Med*","Max*", "(%)*", "Min","Med","Max", "(%)", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                font_size = 6) %>%
  column_spec(1, width = "2cm") %>%  # Set width of 'Dest' column to 1.5cm
  column_spec(2:14, width = "0.4cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "2005" = 4, "2010" = 4, "2015" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  column_spec(6, border_right = TRUE) %>%
  column_spec(10, border_right = TRUE) %>% 
  footnote(general = c("* The symbols used in this table represent the following: 'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_ch03_table_03
```


```{r ch03-make-Heatmap-walking_2015, echo=FALSE, cache=FALSE, include=FALSE}
gss_heatmap <- gss_episodes_renamed %>%
  mutate(WGHT_EPI = ifelse(is.na(WGHT_EPI), 1, WGHT_EPI)) %>% 
  filter(YEAR %in% c(1992,2015))

for(year in unique(gss_heatmap$YEAR)){
  
  for(mode in unique(gss_heatmap$MODE)){
    
    trip_counts <- gss_heatmap %>%
      filter(YEAR == year, MODE == mode) %>% 
      group_by(orig_label, dest_label) %>%
      summarize(count_each_trip = n(), 
                weighted_count = sum(WGHT_EPI), .groups = "drop")

      # Calculate the total weighted count for normalization
      total_weighted_count <- sum(trip_counts$weighted_count)
      
      # Calculate percentages and round to 2 decimal places
      trip_counts <- trip_counts %>%
        mutate(percentage = round((weighted_count / total_weighted_count) * 100, 2))

      # Reshape data for heatmap
      heatmap_data <- dcast(trip_counts, orig_label ~ dest_label, value.var = "percentage")

      # Convert the data frame to a matrix for the heatmap
      heatmap_matrix <- as.matrix(heatmap_data[,-1]) # Remove the first column (orig)
      rownames(heatmap_matrix) <- heatmap_data$orig # Assign row names from the 'orig' column

      # Melt the matrix for use with ggplot
      heatmap_melted <- melt(heatmap_matrix, varnames = c("Origin", "Destination"))

      # Define the order of destinations for 2015
      destination_order <- c("Home", "Work or school", "Grocery store", 
                             "Others' home", "Outdoors", "Neighbourhood", 
                             "Cultural venues", "Place of worship", 
                             "Restaurant", "Sport area", "Business")
      
      # Heatmap for every combination of year and mode
      assign(paste0("heatmap_plot_", year, "_", mode),
               ggplot(heatmap_melted, aes(x = Destination, y = Origin, fill = value)) +
                  geom_tile(color = "white") +
                  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlOrRd"), 
                                       na.value = "gray95", 
                                       limits = c(0, ceiling(max(heatmap_melted$value, na.rm = TRUE))), 
                                       breaks =  c(0, ceiling(max(heatmap_melted$value, na.rm = TRUE))), 
                                       labels = c("0%", paste0(ceiling(max(heatmap_melted$value, na.rm = TRUE)), "%"))) +
                  labs(x = "Destination", y = "Origin", fill = "Percentage", caption = year) +
                  theme_minimal() +
                  theme(
                  axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
                  axis.text.y = element_text(size = 16, margin = margin(l = 15)),
                  axis.title = element_text(size = 16),
                  legend.title = element_text(size = 16, margin = margin(b = 15)), 
                  legend.text = element_text(size = 16),
                  plot.caption = element_text(hjust = 0.5, size = 20, face = "bold", margin = margin(t = 28.35, unit = "pt")))
             ) 
  
  } 
}
```


```{r make-figs, include=FALSE}
heatmap_plot_2015_Walking <- heatmap_plot_2015_Walking +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_2015_Cycling <- heatmap_plot_2015_Cycling +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_1992_Cycling <- heatmap_plot_1992_Cycling +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

heatmap_plot_1992_Walking <- heatmap_plot_1992_Walking +
  coord_fixed(ratio = 1) +
  theme(
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  
    axis.text.x = element_text(size = 14),  
    axis.text.y = element_text(size = 14)) 

# Combine the plots with adjusted spacing
walking_hm_fig <- cowplot::plot_grid(heatmap_plot_1992_Cycling, heatmap_plot_2015_Walking, ncol = 2, align = 'hv',  rel_widths = c(1, 1))

# Save the combined plot to a file
ggsave(file = paste0(here::here(),"/Data-Paper/Manuscript-figures/walking_hm_fig.jpg"), 
       plot = walking_hm_fig,
       width = 17, 
       height = 8, 
       units = "in", 
       dpi = 300)

# Combine the plots with adjusted spacing
cycling_hm_fig <- cowplot::plot_grid(heatmap_plot_1992_Walking, heatmap_plot_2015_Cycling, ncol = 2, align = 'hv',  rel_widths = c(1, 1))

# Save the combined plot to a file
ggsave(file = paste0(here::here(),"/Data-Paper/Manuscript-figures/cycling_hm_fig.jpg"), 
       plot = cycling_hm_fig,
       width = 17, 
       height = 8, 
       units = "in", 
       dpi = 300)
```

```{r echo=FALSE, out.width="100%", fig.cap="Percentage of walking Trips Categorized by Origin and Destination", fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/Data-Paper/Manuscript-figures/walking_hm_fig.jpg"))
```

```{r  echo=FALSE, out.width="100%", fig.cap="Percentage of walking Trips Categorized by Origin and Destination", fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/Data-Paper/Manuscript-figures/cycling_hm_fig.jpg"))
```


# Impedance function for Canadians Metropolitan and Census Agglomerations areas 

```{r echo=FALSE, cache=FALSE, warning=FALSE}
gss_impedances %>% 
filter(dest_label == "Work or school", MODE == "Walking") %>%
  dplyr::select("YEAR", "f_name", "est_1", "est_2", "loglik", "aic", "bic","count") %>%
  mutate(across(c(est_1, est_2), ~ round(., digits = 2)))  %>%
  mutate(across(c(loglik, aic, bic), ~ round(., digits = 0)))  %>%
  unique() %>% 
  kable(format = "latex",
        booktabs = TRUE,
        caption = "\\label{tab:ch03-table-04}Impedance functions and selection criteria for walking trips considering 'Work or school' as destination")
```

```{r}
gss_impedances %>% 
filter(dest_label == "Work or school", MODE == "Walking") %>%
  dplyr::select("YEAR", "f_name", "est_1", "est_2", "loglik", "aic", "bic","count") %>%
  mutate(across(c(est_1, est_2), ~ round(., digits = 2)))  %>%
  mutate(across(c(loglik, aic, bic), ~ round(., digits = 0)))  %>%
  unique()
```


# Concluding remarks



# References {#references .unnumbered}

